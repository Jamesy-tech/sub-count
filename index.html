<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JamesyDeveloper -  Subscriber Count</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a73e8">
</head>
<body>
    <h1 id="subs">Loading...</h1>
    <p id="countdown"></p>
    <p id="debug"></p>
    <button id="installBtn" style="display:none;">Install App</button>

<script>
const apiKey = "AIzaSyAHwcEU_hm_L7zJ65S16GqBX_vJ2_sS02I";
const channelId = "UCBeRITLbzQs2WLP1U7vJ3SQ";
const CHECK_INTERVAL = 120;
let timeLeft = CHECK_INTERVAL;
let lastSubCount = null;

let deferredPrompt;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'inline-block';
});
installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log('Install result:', outcome);
        deferredPrompt = null;
        installBtn.style.display = 'none';
    }
});

if (Notification.permission !== "granted") {
    Notification.requestPermission().then(p => {
        if (p !== "granted") document.getElementById("debug").textContent = "Notifications not allowed";
    });
}

async function loadSubs() {
    try {
        const url = `https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelId}&key=${apiKey}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP error " + res.status);
        const data = await res.json();
        const subs = data.items[0].statistics.subscriberCount;
        document.getElementById("subs").textContent = "Subscribers: " + subs;

        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.ready.then(swReg => {
                swReg.active.postMessage({
                    title: "JamesyDeveloper - YT",
                    body: `You now have ${subs} subscribers.`
                });
                document.getElementById("debug").textContent = "Notification sent via SW";
            });
        } else {
            document.getElementById("debug").textContent = "Service Worker not ready";
        }

        lastSubCount = subs;
    } catch (err) {
        document.getElementById("debug").textContent = "Error fetching sub count: " + err;
    }
}

function updateCountdown() {
    document.getElementById("countdown").textContent = "Next check in: " + timeLeft + "s";
    timeLeft--;
    if (timeLeft < 0) {
        loadSubs();
        timeLeft = CHECK_INTERVAL;
    }
}

loadSubs();
setInterval(updateCountdown, 1000);

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(swReg => {
        if (swReg.active) {
            swReg.active.postMessage({
                title: "JamesyDeveloper - YT",
                body: `You now have ${subs} subscribers.`
            });
            document.getElementById("debug").textContent = "Notification sent via SW";
        } else {
            document.getElementById("debug").textContent = "Service Worker not active yet";
        }
    });
}

</script>
</body>
</html>
